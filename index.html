<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Corporate Car Booking</title>
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/locale/th.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/isBetween.js"></script>

    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f3f4f6; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; height: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 4px; }
        
        /* Glassmorphism */
        .glass {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .status-badge { @apply px-2 py-1 rounded-full text-xs font-semibold; }
        .status-pending { @apply bg-yellow-100 text-yellow-800; }
        .status-approved { @apply bg-green-100 text-green-800; }
        .status-rejected { @apply bg-red-100 text-red-800; }
        .status-completed { @apply bg-gray-100 text-gray-800; }

        .modal {
            transition: opacity 0.3s ease-in-out;
            opacity: 0;
            pointer-events: none;
        }
        .modal.active {
            opacity: 1;
            pointer-events: auto;
        }
        .modal-content {
            transform: scale(0.95);
            transition: transform 0.3s ease-in-out;
        }
        .modal.active .modal-content {
            transform: scale(1);
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- App Container -->
    <div id="app" class="min-h-screen"></div>

    <!-- Script Logic -->
    <script>
        // --- CONFIGURATION ---
        dayjs.locale('th');
        dayjs.extend(dayjs_plugin_isBetween);

        // ⚠️ แก้ไข URL ตรงนี้ให้เป็น ngrok ของคุณ
        // (และอย่าลืม /api ต่อท้าย)
        const API_BASE_URL = "https://obtrusive-interlinearly-everette.ngrok-free.dev";
        const API_URL = `${API_BASE_URL}/api`;

        // ✅ ตั้งค่า Axios ให้ทะลุหน้าแจ้งเตือนของ ngrok (สำคัญมาก!)
        axios.defaults.headers.common['ngrok-skip-browser-warning'] = 'true';
        axios.defaults.headers.common['Content-Type'] = 'application/json';

        // --- STATE MANAGEMENT ---
        let state = {
            currentUser: null, // { username, role, ... }
            view: 'login', // login, dashboard, history, admin
            bookings: [],
            cars: [],
            drivers: [],
            users: []
        };

        const api = {
            async login(username, password) {
                try {
                    const res = await axios.post(`${API_URL}/login`, { username, password });
                    if (res.data.success) {
                        state.currentUser = res.data.user;
                        state.view = 'dashboard';
                        localStorage.setItem('user', JSON.stringify(res.data.user));
                        renderApp();
                        this.fetchData();
                    }
                } catch (err) {
                    Swal.fire('Login Failed', 'Username or Password incorrect', 'error');
                }
            },

            async fetchData() {
                try {
                    console.log("Fetching data from:", `${API_URL}/data`);
                    const res = await axios.get(`${API_URL}/data`);
                    console.log("Data received:", res.data);
                    
                    state.bookings = res.data.bookings || [];
                    state.cars = res.data.cars || [];
                    state.drivers = res.data.drivers || [];
                    state.users = res.data.users || []; // For admin
                    renderApp();
                } catch (err) {
                    console.error("Error fetching data:", err);
                    // ถ้า Error เพราะ ngrok อาจจะยังแจ้งเตือน user ได้
                    if(err.response && err.response.headers['content-type'].includes('text/html')) {
                        Swal.fire('Connection Error', 'กรุณาตรวจสอบ ngrok link หรือ Network', 'warning');
                    }
                }
            },

            async action(method, endpoint, data = {}) {
                try {
                    const res = await axios({ method, url: `${API_URL}/${endpoint}`, data });
                    return res.data;
                } catch (err) {
                    throw err;
                }
            },

            logout() {
                state.currentUser = null;
                state.view = 'login';
                localStorage.removeItem('user');
                renderApp();
            }
        };

        // --- COMPONENTS & RENDER ---
        function renderApp() {
            const app = document.getElementById('app');
            
            // Check LocalStorage Session
            if (!state.currentUser) {
                const saved = localStorage.getItem('user');
                if (saved) {
                    state.currentUser = JSON.parse(saved);
                    api.fetchData(); // Load data if session exists
                }
            }

            if (!state.currentUser) {
                renderLogin(app);
            } else {
                renderDashboard(app);
            }
        }

        function renderLogin(container) {
            container.innerHTML = `
                <div class="flex items-center justify-center min-h-screen bg-gradient-to-br from-blue-600 to-indigo-900">
                    <div class="bg-white p-8 rounded-2xl shadow-2xl w-96 glass">
                        <div class="text-center mb-8">
                            <div class="bg-blue-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                                <i data-lucide="car" class="w-8 h-8 text-blue-600"></i>
                            </div>
                            <h1 class="text-2xl font-bold text-gray-800">Corporate Car</h1>
                            <p class="text-gray-500 text-sm">ระบบจองรถส่วนกลาง</p>
                        </div>
                        <form onsubmit="handleLogin(event)" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Username</label>
                                <input type="text" id="username" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="user / admin" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                                <input type="password" id="password" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="123" required>
                            </div>
                            <button class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg font-semibold transition shadow-lg">
                                เข้าสู่ระบบ
                            </button>
                        </form>
                        <div class="mt-6 text-center text-xs text-gray-400">
                            Demo: user/123 or admin/123
                        </div>
                    </div>
                </div>
            `;
            lucide.createIcons();
        }

        function renderDashboard(container) {
            const isUser = state.currentUser.role === 'user';
            
            container.innerHTML = `
                <div class="flex h-screen overflow-hidden bg-gray-100">
                    <!-- Sidebar -->
                    <aside class="w-64 bg-white shadow-md z-10 hidden md:flex flex-col">
                        <div class="p-6 border-b flex items-center gap-3">
                            <div class="bg-blue-600 p-2 rounded-lg text-white"><i data-lucide="car"></i></div>
                            <span class="font-bold text-lg text-blue-900">CarBooking</span>
                        </div>
                        <nav class="flex-1 p-4 space-y-2">
                            <button onclick="changeView('dashboard')" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl ${state.view === 'dashboard' ? 'bg-blue-50 text-blue-600' : 'text-gray-600 hover:bg-gray-50'}">
                                <i data-lucide="layout-dashboard" class="w-5 h-5"></i> Dashboard
                            </button>
                            ${!isUser ? `
                            <button onclick="changeView('admin')" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl ${state.view === 'admin' ? 'bg-blue-50 text-blue-600' : 'text-gray-600 hover:bg-gray-50'}">
                                <i data-lucide="shield-check" class="w-5 h-5"></i> Admin Approvals
                            </button>` : ''}
                            <button onclick="changeView('history')" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl ${state.view === 'history' ? 'bg-blue-50 text-blue-600' : 'text-gray-600 hover:bg-gray-50'}">
                                <i data-lucide="history" class="w-5 h-5"></i> ประวัติการจอง
                            </button>
                        </nav>
                        <div class="p-4 border-t">
                            <div class="flex items-center gap-3 mb-4 px-2">
                                <div class="w-10 h-10 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-700 font-bold">
                                    ${state.currentUser.username[0].toUpperCase()}
                                </div>
                                <div>
                                    <div class="font-semibold text-sm">${state.currentUser.firstName || state.currentUser.username}</div>
                                    <div class="text-xs text-gray-500 capitalize">${state.currentUser.role}</div>
                                </div>
                            </div>
                            <button onclick="api.logout()" class="w-full flex items-center justify-center gap-2 text-red-500 hover:bg-red-50 py-2 rounded-lg text-sm transition">
                                <i data-lucide="log-out" class="w-4 h-4"></i> Sign Out
                            </button>
                        </div>
                    </aside>

                    <!-- Main Content -->
                    <main class="flex-1 overflow-y-auto custom-scrollbar relative">
                        <!-- Mobile Header -->
                        <header class="md:hidden bg-white p-4 shadow-sm flex justify-between items-center sticky top-0 z-20">
                            <div class="font-bold text-blue-600">CarBooking</div>
                            <button onclick="api.logout()" class="text-gray-500"><i data-lucide="log-out"></i></button>
                        </header>

                        <div class="p-6 max-w-6xl mx-auto space-y-6">
                            ${renderContent()}
                        </div>
                    </main>
                </div>

                <!-- Modals -->
                <div id="booking-modal" class="modal fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm"></div>
            `;
            lucide.createIcons();
        }

        function renderContent() {
            if (state.view === 'dashboard') {
                const todayBookings = state.bookings.filter(b => dayjs(b.startTime).isSame(dayjs(), 'day'));
                const myActiveBookings = state.bookings.filter(b => b.user === state.currentUser.username && ['pending', 'approved'].includes(b.status));

                return `
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <!-- Stats -->
                        <div class="bg-gradient-to-r from-blue-500 to-blue-600 p-6 rounded-2xl text-white shadow-lg">
                            <div class="text-blue-100 text-sm mb-1">รถว่างตอนนี้</div>
                            <div class="text-4xl font-bold">${state.cars.length} <span class="text-lg font-normal">คัน</span></div>
                        </div>
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                            <div class="text-gray-500 text-sm mb-1">การจองวันนี้</div>
                            <div class="text-4xl font-bold text-gray-800">${todayBookings.length}</div>
                        </div>
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                            <div class="text-gray-500 text-sm mb-1">รออนุมัติ</div>
                            <div class="text-4xl font-bold text-yellow-600">${state.bookings.filter(b => b.status === 'pending').length}</div>
                        </div>
                    </div>

                    <!-- Action Bar -->
                    <div class="flex justify-between items-center bg-white p-4 rounded-xl shadow-sm">
                        <h2 class="font-bold text-lg text-gray-700">รายการรถพร้อมให้บริการ</h2>
                        <button onclick="openBookingModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg flex items-center gap-2 shadow-md transition transform hover:scale-105">
                            <i data-lucide="plus-circle" class="w-5 h-5"></i> จองรถใหม่
                        </button>
                    </div>

                    <!-- Car List -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        ${state.cars.map(car => `
                            <div class="bg-white rounded-2xl p-5 shadow-sm hover:shadow-md transition border border-gray-100">
                                <div class="flex justify-between items-start mb-4">
                                    <div>
                                        <h3 class="font-bold text-lg text-gray-800">${car.name}</h3>
                                        <div class="text-sm text-gray-500 bg-gray-100 px-2 py-0.5 rounded inline-block mt-1">${car.plate}</div>
                                    </div>
                                    <div class="bg-green-100 text-green-700 p-2 rounded-full"><i data-lucide="check" class="w-5 h-5"></i></div>
                                </div>
                                <div class="space-y-2 text-sm text-gray-600">
                                    <div class="flex items-center gap-2"><i data-lucide="users" class="w-4 h-4"></i> 4 ที่นั่ง</div>
                                    <div class="flex items-center gap-2"><i data-lucide="fuel" class="w-4 h-4"></i> เบนซิน 95</div>
                                </div>
                                <button onclick="openBookingModal('${car._id}')" class="w-full mt-4 border border-blue-600 text-blue-600 py-2 rounded-lg hover:bg-blue-50 font-medium transition">
                                    จองคันนี้
                                </button>
                            </div>
                        `).join('')}
                    </div>
                `;
            } else if (state.view === 'history') {
                const myBookings = state.bookings
                    .filter(b => b.user === state.currentUser.username)
                    .sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt));

                return `
                    <h2 class="font-bold text-2xl mb-4">ประวัติการจองของฉัน</h2>
                    <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full text-left text-sm">
                                <thead class="bg-gray-50 border-b">
                                    <tr>
                                        <th class="p-4 font-semibold text-gray-600">วันที่จอง</th>
                                        <th class="p-4 font-semibold text-gray-600">รถ</th>
                                        <th class="p-4 font-semibold text-gray-600">วันเดินทาง</th>
                                        <th class="p-4 font-semibold text-gray-600">สถานะ</th>
                                        <th class="p-4 font-semibold text-gray-600">จัดการ</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y">
                                    ${myBookings.length ? myBookings.map(b => {
                                        const car = state.cars.find(c => c._id === b.carId) || {name: 'Deleted Car', plate: '-'};
                                        return `
                                        <tr class="hover:bg-gray-50">
                                            <td class="p-4 text-gray-500">${dayjs(b.createdAt).format('DD/MM/BB HH:mm')}</td>
                                            <td class="p-4">
                                                <div class="font-medium">${car.name}</div>
                                                <div class="text-xs text-gray-400">${car.plate}</div>
                                            </td>
                                            <td class="p-4">
                                                <div>${dayjs(b.startTime).format('DD MMM BB HH:mm')}</div>
                                                <div class="text-xs text-gray-400">ถึง ${dayjs(b.endTime).format('DD MMM BB HH:mm')}</div>
                                            </td>
                                            <td class="p-4"><span class="status-badge status-${b.status}">${b.status}</span></td>
                                            <td class="p-4">
                                                ${b.status === 'approved' ? 
                                                    `<button onclick="openExtendModal('${b._id}')" class="text-blue-600 hover:underline text-xs">ขอเพิ่มเวลา</button>` : 
                                                    '-'}
                                            </td>
                                        </tr>
                                    `}).join('') : `<tr><td colspan="5" class="p-8 text-center text-gray-500">ไม่มีข้อมูลการจอง</td></tr>`}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            } else if (state.view === 'admin') {
                const pending = state.bookings.filter(b => b.status === 'pending');
                return `
                    <h2 class="font-bold text-2xl mb-4">รายการรออนุมัติ (${pending.length})</h2>
                    <div class="space-y-4">
                        ${pending.length ? pending.map(b => {
                            const car = state.cars.find(c => c._id === b.carId) || {};
                            return `
                            <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-yellow-400 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                                <div>
                                    <div class="flex items-center gap-2 mb-2">
                                        <span class="font-bold text-lg">${b.user}</span>
                                        <span class="text-sm text-gray-500 bg-gray-100 px-2 rounded">แผนก ${b.department || '-'}</span>
                                    </div>
                                    <div class="text-gray-600 text-sm space-y-1">
                                        <div><i data-lucide="car" class="w-4 h-4 inline mr-1"></i> ${car.name} (${car.plate})</div>
                                        <div><i data-lucide="calendar" class="w-4 h-4 inline mr-1"></i> ${dayjs(b.startTime).format('DD/MM/BB HH:mm')} - ${dayjs(b.endTime).format('HH:mm')}</div>
                                        <div><i data-lucide="map-pin" class="w-4 h-4 inline mr-1"></i> ${b.destination} (${b.passengers} คน)</div>
                                        <div class="text-xs text-gray-400">เหตุผล: ${b.purpose}</div>
                                    </div>
                                </div>
                                <div class="flex gap-3 w-full md:w-auto">
                                    <button onclick="handleApprove('${b._id}', 'approved')" class="flex-1 md:flex-none bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg shadow-sm transition">อนุมัติ</button>
                                    <button onclick="openRejectModal('${b._id}')" class="flex-1 md:flex-none bg-red-100 hover:bg-red-200 text-red-700 px-6 py-2 rounded-lg transition">ไม่อนุมัติ</button>
                                </div>
                            </div>
                        `}).join('') : `<div class="text-center py-10 text-gray-500 bg-white rounded-xl">ไม่มีรายการรออนุมัติ</div>`}
                    </div>
                `;
            }
        }

        // --- HANDLERS ---
        function handleLogin(e) {
            e.preventDefault();
            const u = document.getElementById('username').value;
            const p = document.getElementById('password').value;
            api.login(u, p);
        }

        function changeView(v) { state.view = v; renderApp(); }

        let modalData = null;
        function openBookingModal(carId = null) {
            const modal = document.getElementById('booking-modal');
            const today = dayjs().format('YYYY-MM-DD');
            const now = dayjs().format('HH:mm');
            
            modal.innerHTML = `
                <div class="bg-white p-6 rounded-2xl w-full max-w-md shadow-2xl modal-content m-4">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="font-bold text-xl text-gray-800">รายละเอียดการจอง</h3>
                        <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600"><i data-lucide="x"></i></button>
                    </div>
                    <form onsubmit="handleBookingSubmit(event)" class="space-y-4">
                        <div>
                            <label class="text-sm font-medium text-gray-700">เลือกรถ</label>
                            <select id="booking-car" class="w-full border p-2.5 rounded-lg bg-gray-50 mt-1" required>
                                ${state.cars.map(c => `<option value="${c._id}" ${c._id === carId ? 'selected' : ''}>${c.name} (${c.plate})</option>`).join('')}
                            </select>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-sm font-medium text-gray-700">วันที่เดินทาง</label>
                                <input type="date" id="booking-date" class="w-full border p-2.5 rounded-lg mt-1" required min="${today}" value="${today}">
                            </div>
                            <div>
                                <label class="text-sm font-medium text-gray-700">เวลาเริ่ม</label>
                                <input type="time" id="booking-time" class="w-full border p-2.5 rounded-lg mt-1" required value="${now}">
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-sm font-medium text-gray-700">ถึงวันที่</label>
                                <input type="date" id="booking-end-date" class="w-full border p-2.5 rounded-lg mt-1" required min="${today}" value="${today}">
                            </div>
                            <div>
                                <label class="text-sm font-medium text-gray-700">เวลาสิ้นสุด</label>
                                <input type="time" id="booking-end-time" class="w-full border p-2.5 rounded-lg mt-1" required>
                            </div>
                        </div>
                        <div>
                            <label class="text-sm font-medium text-gray-700">สถานที่ปลายทาง</label>
                            <input type="text" id="booking-dest" class="w-full border p-2.5 rounded-lg mt-1" placeholder="ระบุสถานที่" required>
                        </div>
                        <div>
                            <label class="text-sm font-medium text-gray-700">เหตุผลการใช้รถ</label>
                            <textarea id="booking-purpose" class="w-full border p-2.5 rounded-lg mt-1" rows="2" placeholder="เช่น ไปพบลูกค้า..."></textarea>
                        </div>
                        <div class="flex gap-4 items-center">
                             <div class="flex-1">
                                <label class="text-sm font-medium text-gray-700">จำนวนผู้โดยสาร</label>
                                <input type="number" id="booking-passenger" class="w-full border p-2.5 rounded-lg mt-1" min="1" max="10" value="1" required>
                             </div>
                             <div class="flex items-center pt-6 gap-2">
                                <input type="checkbox" id="booking-driver" class="w-4 h-4 text-blue-600 rounded">
                                <label for="booking-driver" class="text-sm text-gray-700">ต้องการคนขับ</label>
                             </div>
                        </div>

                        <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold hover:bg-blue-700 transition mt-2 shadow-lg">
                            ยืนยันการจอง
                        </button>
                    </form>
                </div>
            `;
            lucide.createIcons();
            modal.classList.add('active');
        }

        async function handleBookingSubmit(e) {
            e.preventDefault();
            
            // Collect Data
            const carId = document.getElementById('booking-car').value;
            const date = document.getElementById('booking-date').value;
            const time = document.getElementById('booking-time').value;
            const endDate = document.getElementById('booking-end-date').value;
            const endTime = document.getElementById('booking-end-time').value;

            const start = new Date(`${date}T${time}`);
            const end = new Date(`${endDate}T${endTime}`);

            if(end <= start) return Swal.fire('Error', 'เวลาสิ้นสุดต้องหลังจากเวลาเริ่ม', 'error');

            const payload = {
                carId,
                startTime: start.toISOString(),
                endTime: end.toISOString(),
                destination: document.getElementById('booking-dest').value,
                purpose: document.getElementById('booking-purpose').value,
                passengers: parseInt(document.getElementById('booking-passenger').value),
                user: state.currentUser.username, // ⚠️ Send current user
                department: state.currentUser.department || 'General'
            };

            try {
                // Submit
                await api.action('post', 'bookings', payload);
                Swal.fire({ icon: 'success', title: 'จองสำเร็จ!', text: 'กรุณารอการอนุมัติจาก Admin', timer: 1500 });
                closeModal();
                
                // ✅ RE-FETCH DATA
                await api.fetchData(); 

            } catch (err) {
                Swal.fire('เกิดข้อผิดพลาด', err.response?.data?.error || err.message, 'error');
            }
        }

        function closeModal() {
            document.getElementById('booking-modal').classList.remove('active');
        }

        async function handleApprove(id, status) {
            try {
                await api.action('put', `bookings/${id}`, { status });
                Swal.fire('Success', 'อัปเดตสถานะเรียบร้อย', 'success');
                api.fetchData();
            } catch(err) {
                Swal.fire('Error', err.message, 'error');
            }
        }

        function openRejectModal(id) {
            modalData = { id };
            const modal = document.getElementById('booking-modal');
            modal.classList.add('active');
            modal.innerHTML = `
                <div class="flex items-center justify-center min-h-full p-4">
                    <div class="bg-white p-6 rounded-xl w-80 modal-content">
                        <h3 class="font-bold mb-4 text-red-600">ระบุเหตุผลที่ไม่อนุมัติ</h3>
                        <textarea id="rejectReason" class="w-full border p-2 rounded mb-4" rows="3"></textarea>
                        <div class="flex justify-end gap-2">
                            <button onclick="closeModal()" class="text-gray-500 px-3">ยกเลิก</button>
                            <button onclick="confirmReject()" class="bg-red-600 text-white px-4 py-2 rounded">ยืนยัน</button>
                        </div>
                    </div>
                </div>
            `;
        }

        function openExtendModal(id) {
            // Simple extend logic for demo
            const modal = document.getElementById('booking-modal');
            modal.classList.add('active');
            modal.innerHTML = `
                <div class="flex items-center justify-center min-h-full p-4">
                    <div class="bg-white p-6 rounded-xl w-80 modal-content">
                        <h3 class="font-bold mb-4 text-blue-600">ขอต่อเวลาเพิ่ม</h3>
                        <form onsubmit="handleExtendSubmit(event)" class="space-y-3">
                            <div><label class="text-xs">สิ้นสุดวันที่</label><input type="date" id="extend-date" class="w-full border p-2 rounded" required></div>
                            <div><label class="text-xs">เวลาใหม่</label><input type="time" id="extend-time" class="w-full border p-2 rounded" required></div>
                            <div class="flex justify-end gap-2 mt-4">
                                <button type="button" onclick="closeModal()" class="text-gray-500">ยกเลิก</button>
                                <button class="bg-blue-600 text-white px-3 py-1 rounded">ยืนยัน</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
        }

        function confirmReject() {
             const reason = document.getElementById('rejectReason').value;
             if(!reason) return Swal.fire('กรุณาระบุเหตุผล');
             api.action('put', `bookings/${modalData.id}`, { status: 'rejected', rejectionReason: reason }).then(()=>{ closeModal(); api.fetchData(); });
        }

        // Init
        window.onload = () => {
            renderApp();
            if (state.currentUser) api.fetchData();
        }

    </script>
</body>
</html>
