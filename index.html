<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vana Nava Corporate Trip Booking</title>
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/locale/th.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/isBetween.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;700&display=swap');
        body { font-family: 'Sarabun', sans-serif; background-color: #f3f4f6; }
        
        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }

        /* Animations */
        .fade-in { animation: fadeIn 0.4s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Modal Transitions */
        .modal { transition: opacity 0.2s ease, visibility 0.2s ease; opacity: 0; visibility: hidden; pointer-events: none; z-index: 50; }
        .modal.show { opacity: 1; visibility: visible; pointer-events: auto; }
        .modal-content { transform: scale(0.95); transition: transform 0.2s ease; }
        .modal.show .modal-content { transform: scale(1); }

        /* Calendar Styles */
        .calendar-day { min-height: 120px; background: white; border-right: 1px solid #f3f4f6; border-bottom: 1px solid #f3f4f6; transition: background 0.2s; }
        .calendar-day:hover { background-color: #f9fafb; }
        .calendar-day.other-month { background-color: #f9fafb; color: #d1d5db; }
        .event-pill { font-size: 11px; padding: 2px 6px; border-radius: 4px; margin-bottom: 2px; color: white; cursor: pointer; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; box-shadow: 0 1px 2px rgba(0,0,0,0.1); transition: transform 0.1s; }
        .event-pill:hover { transform: scale(1.02); filter: brightness(0.95); z-index: 10; position: relative; }
        
        /* Status Colors */
        .status-approved { background-color: #2563eb; } /* Blue */
        .status-active { background-color: #16a34a; }   /* Green */
        .status-maintenance { background-color: #f97316; } /* Orange */
        .status-pending { background-color: #eab308; } /* Yellow */
        .status-rejected { background-color: #ef4444; } /* Red */
        .status-completed { background-color: #0d9488; } /* Teal */
        .status-cancelled { background-color: #9ca3af; text-decoration: line-through; } /* Gray */

        /* Bulk Calendar Styles */
        .bulk-day { height: 60px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; border: 1px solid #e5e7eb; border-radius: 8px; transition: all 0.2s; position: relative; }
        .bulk-day:hover { background-color: #f3f4f6; border-color: #d1d5db; }
        .bulk-day.selected { background-color: #fff7ed; border-color: #f97316; color: #c2410c; font-weight: bold; box-shadow: 0 2px 4px rgba(249, 115, 22, 0.1); }
        .bulk-day.has-conflict { background-color: #fee2e2; border-color: #ef4444; color: #b91c1c; opacity: 0.8; } /* Conflict styling */
        .bulk-header { cursor: pointer; transition: color 0.2s; }
        .bulk-header:hover { color: #f97316; text-decoration: underline; }
        .dot-indicator { width: 6px; height: 6px; border-radius: 50%; position: absolute; bottom: 6px; }
        .dot-conflict { background-color: #ef4444; }
    </style>
</head>
<body class="text-gray-800 antialiased font-sarabun">

    <div id="app" class="min-h-screen flex flex-col"></div>
    <div id="modals-container"></div>
    
    <script>
        // --- INITIAL SETUP ---
        dayjs.extend(window.dayjs_plugin_isBetween);
        dayjs.locale('th');

        // üî• CONFIGURATION
        const API_URL = 'https://obtrusive-interlinearly-everette.ngrok-free.dev/api'; 
        const LINE_BOT_ID = '@342rmqlv'; 
        const DEPARTMENTS = ["Admissions", "Executive Office", "Engineer", "Food & Beverage", "Finance", "Housekeeping", "HR & TQM", "Information & Technology", "Operations", "Retails", "Sales"];

        // Axios Configuration
        axios.defaults.headers.common['ngrok-skip-browser-warning'] = 'true';
        axios.interceptors.request.use(config => {
            const token = localStorage.getItem('authToken');
            if (token) config.headers['Authorization'] = `Bearer ${token}`;
            return config;
        }, error => Promise.reject(error));

        axios.interceptors.response.use(response => response, error => {
            if (error.response && (error.response.status === 401 || error.response.status === 403)) {
                if (!error.config.url.includes('/login')) {
                    localStorage.removeItem('authToken');
                    localStorage.removeItem('carBookingUser');
                    location.reload();
                }
            }
            return Promise.reject(error);
        });

        // Global State
        const state = { 
            currentUser: null, 
            viewMode: 'dashboard', 
            bookings: [], 
            cars: [], 
            drivers: [], 
            users: [], 
            stats: {}, 
            currentDate: new Date() 
        };
        let modalData = {};
        let bulkState = { selectedDates: new Set(), currentMonth: dayjs(), resourceType: null, resourceId: null, resourceName: null };

        // Load Session
        try { state.currentUser = JSON.parse(localStorage.getItem('carBookingUser')); } catch (e) { localStorage.clear(); }

        // API Wrapper
        const api = {
            login: (d) => axios.post(`${API_URL}/login`, d),
            fetchData: async () => {
                try {
                    const [c, d, b] = await Promise.all([
                        axios.get(`${API_URL}/cars`).catch(()=>({data:[]})), 
                        axios.get(`${API_URL}/drivers`).catch(()=>({data:[]})), 
                        axios.get(`${API_URL}/bookings`).catch(()=>({data:[]}))
                    ]);
                    
                    state.cars = c.data || []; 
                    state.drivers = d.data || []; 
                    state.bookings = b.data || [];
                    
                    if (state.currentUser?.role === 'admin') {
                        const [u, s] = await Promise.all([
                            axios.get(`${API_URL}/users`).catch(()=>({data:[]})), 
                            axios.get(`${API_URL}/stats`).catch(()=>({data:{}}))
                        ]);
                        state.users = u.data || []; 
                        state.stats = s.data || {};
                    }
                    renderApp(); 
                } catch (e) { console.error("Fetch Error:", e); }
            },
            action: async (m, ep, d) => { 
                try { 
                    const r = await axios[m](`${API_URL}/${ep}`, d); 
                    return { success: true, data: r.data }; 
                } catch (e) { 
                    return { success: false, message: e.response?.data?.message || e.message }; 
                } 
            }
        };

        // --- RENDER MAIN ---
        function renderApp() {
            const app = document.getElementById('app');
            app.innerHTML = '';
            
            if (!state.currentUser) {
                renderLogin(app);
            } else {
                renderNavbar(app);
                renderMainContent(app);
                renderModals();
                lucide.createIcons();
            }
        }

        // üî• VANA NAVA THEMED LOGIN UI üî•
        function renderLogin(c) {
            c.innerHTML = `
            <div class="min-h-screen w-full flex items-center justify-center bg-blue-900 relative overflow-hidden fade-in">
                <!-- Background with Blur Overlay -->
                <div class="absolute inset-0 z-0">
                     <img src="./11-12-2025 17-28-23.png" onerror="this.src='https://images.unsplash.com/photo-1575429198097-0414ec08e8cd?q=80&w=2940&auto=format&fit=crop'" 
                         class="w-full h-full object-cover opacity-60 blur-sm scale-105" alt="Background">
                    <div class="absolute inset-0 bg-gradient-to-t from-blue-900/90 to-cyan-800/40"></div>
                </div>

                <!-- Login Card -->
                <div class="bg-white/95 backdrop-blur-md p-8 md:p-10 rounded-2xl shadow-2xl w-full max-w-[400px] relative z-10 border border-white/20">
                    
                    <!-- Header & Logo -->
                    <div class="text-center mb-8">
                        <div class="flex items-center justify-center mb-4 relative">
                             <div class="relative">
                                <i data-lucide="palmtree" class="w-20 h-20 text-blue-600 drop-shadow-sm"></i>
                                <div class="absolute -bottom-2 -right-3 bg-white rounded-full p-1.5 shadow-md border border-gray-100">
                                    <i data-lucide="bus" class="w-8 h-8 text-cyan-500 fill-cyan-50"></i>
                                </div>
                             </div>
                        </div>
                        <h1 class="text-2xl font-bold text-gray-800 tracking-tight">Vana Nava Corporate Trip</h1>
                        <p class="text-sm text-gray-500 mt-1 font-medium">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á‡∏£‡∏ñ‡∏£‡∏±‡∏ö-‡∏™‡πà‡∏á‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (Vana Nava Water Jungle)</p>
                    </div>

                    <form id="loginForm" class="space-y-5">
                        <!-- Username -->
                        <div>
                            <label class="block text-xs font-bold text-gray-600 mb-1.5 uppercase tracking-wide">‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</label>
                            <div class="relative group">
                                <div class="absolute inset-y-0 left-0 pl-3.5 flex items-center pointer-events-none">
                                    <i data-lucide="user" class="text-gray-400 w-5 h-5 group-focus-within:text-blue-500 transition-colors"></i>
                                </div>
                                <input name="username" class="w-full border border-gray-300 p-3 pl-11 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition bg-gray-50 focus:bg-white placeholder-gray-400" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô" required>
                            </div>
                        </div>

                        <!-- Password -->
                        <div>
                            <label class="block text-xs font-bold text-gray-600 mb-1.5 uppercase tracking-wide">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
                            <div class="relative group">
                                <div class="absolute inset-y-0 left-0 pl-3.5 flex items-center pointer-events-none">
                                    <i data-lucide="lock" class="text-gray-400 w-5 h-5 group-focus-within:text-blue-500 transition-colors"></i>
                                </div>
                                <input type="password" name="password" class="w-full border border-gray-300 p-3 pl-11 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition bg-gray-50 focus:bg-white placeholder-gray-400" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" required>
                            </div>
                            <!-- Forgot Password -->
                            <div class="text-right mt-2">
                                <a href="#" onclick="Swal.fire({icon:'info', title:'‡∏•‡∏∑‡∏°‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô?', text:'‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÅ‡∏ú‡∏ô‡∏Å IT ‡∏´‡∏£‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô'})" class="text-xs text-blue-600 hover:text-blue-800 font-medium hover:underline transition">‡∏•‡∏∑‡∏°‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô?</a>
                            </div>
                        </div>

                        <!-- Button -->
                        <button class="w-full bg-gradient-to-r from-blue-600 to-cyan-500 text-white p-3.5 rounded-xl font-bold hover:shadow-lg hover:from-blue-700 hover:to-cyan-600 transition-all transform active:scale-[0.98] flex items-center justify-center gap-2 mt-2">
                            <span>‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á‡∏£‡∏ñ</span>
                            <i data-lucide="arrow-right" class="w-4 h-4"></i>
                        </button>
                    </form>

                    <div class="mt-8 text-center border-t pt-4">
                        <p class="text-[10px] text-gray-400">¬© 2024 Vana Nava Corporate Transport System</p>
                    </div>
                </div>
            </div>`;
            
            document.getElementById('loginForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const btn = e.target.querySelector('button');
                const originalText = btn.innerHTML;
                btn.disabled = true;
                btn.innerHTML = `<span class="animate-spin mr-2"><i data-lucide="loader-2"></i></span> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...`;
                lucide.createIcons();

                try {
                    const res = await api.login(Object.fromEntries(new FormData(e.target)));
                    localStorage.setItem('authToken', res.data.token); 
                    localStorage.setItem('carBookingUser', JSON.stringify(res.data.user));
                    state.currentUser = res.data.user;
                    
                    const Toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 1500, timerProgressBar: true });
                    Toast.fire({ icon: 'success', title: `‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏Ñ‡∏∏‡∏ì ${res.data.user.firstName}` });
                    
                    if(res.data.user.mustChangePassword) setTimeout(() => openModal('changePwdModal'), 800);
                    else setTimeout(() => api.fetchData(), 800);
                } catch (err) { 
                    Swal.fire({ icon: 'error', title: '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', text: err.response?.data?.message || '‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á' });
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                    lucide.createIcons();
                }
            });
            lucide.createIcons();
        }

        function renderNavbar(c) {
            c.innerHTML += `
            <nav class="bg-white shadow-sm px-6 py-3 flex flex-col md:flex-row justify-between items-center sticky top-0 z-40 border-b border-gray-100">
                <div class="flex items-center gap-3 font-bold text-lg text-gray-800">
                    <div class="bg-gradient-to-tr from-blue-600 to-cyan-500 text-white p-2 rounded-lg shadow-sm"><i data-lucide="bus" class="w-5 h-5"></i></div> 
                    <span>${state.currentUser.role==='admin'?'Admin Panel (Vana Nava)':'Booking Portal'}</span>
                </div>
                <div class="flex items-center gap-4 mt-2 md:mt-0">
                    <button onclick="openLineQR()" class="bg-[#06C755] hover:bg-[#05b34c] text-white px-4 py-1.5 rounded-full text-xs font-bold flex items-center gap-2 shadow-sm transition-all transform hover:scale-105">
                        <i data-lucide="bell" class="w-4 h-4"></i> ‡∏£‡∏±‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô LINE
                    </button>
                    <div class="h-6 w-px bg-gray-200"></div>
                    <div class="flex items-center gap-3">
                        <div class="text-right hidden md:block">
                            <div class="text-sm font-bold text-gray-800">${state.currentUser.firstName} ${state.currentUser.lastName}</div>
                            <div class="text-[10px] text-gray-500 uppercase tracking-wider">${state.currentUser.department}</div>
                        </div>
                        <button onclick="openModal('changePwdModal')" class="p-2 hover:bg-gray-100 rounded-full text-gray-500 transition" title="‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô"><i data-lucide="key" class="w-5 h-5"></i></button>
                        <button onclick="logout()" class="p-2 hover:bg-red-50 text-red-500 rounded-full transition" title="‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö"><i data-lucide="log-out" class="w-5 h-5"></i></button>
                    </div>
                </div>
            </nav>`;
        }

        function renderMainContent(c) {
            const main = document.createElement('div'); 
            main.className = "max-w-7xl mx-auto p-4 md:p-6 w-full fade-in pb-24";
            
            const tabs = state.currentUser.role === 'admin' 
                ? [
                    {id:'dashboard', l:'‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏° & ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£', i:'layout-dashboard'}, 
                    {id:'history', l:'‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ & ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô', i:'file-text'}, 
                    {id:'calendar', l:'‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏á‡∏≤‡∏ô', i:'calendar'}, 
                    {id:'users', l:'‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô', i:'users'}
                  ]
                : [
                    {id:'dashboard', l:'‡∏à‡∏≠‡∏á‡∏£‡∏ñ', i:'plus-circle'}, 
                    {id:'calendar', l:'‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏£‡∏ñ‡∏ß‡πà‡∏≤‡∏á', i:'calendar'}
                  ];
            
            main.innerHTML += `
            <div class="flex gap-2 mb-6 overflow-x-auto pb-1 scrollbar-hide">
                ${tabs.map(t => `
                    <button onclick="state.viewMode='${t.id}';renderApp()" 
                        class="flex items-center gap-2 px-5 py-2.5 rounded-xl text-sm font-bold transition-all duration-200 whitespace-nowrap ${state.viewMode===t.id ? 'bg-blue-600 text-white shadow-md transform scale-105' : 'bg-white text-gray-600 border border-gray-200 hover:bg-gray-50 hover:border-gray-300'}">
                        <i data-lucide="${t.i}" class="w-4 h-4"></i> ${t.l}
                    </button>
                `).join('')}
            </div>`;
            
            const content = document.createElement('div');
            if(state.viewMode==='dashboard') state.currentUser.role==='admin'?renderAdminDashboard(content):renderUserDashboard(content);
            else if(state.viewMode==='history') renderHistoryView(content);
            else if(state.viewMode==='calendar') renderCalendar(content);
            else if(state.viewMode==='users') renderUserManagement(content);
            main.appendChild(content); 
            c.appendChild(main);

            if(state.currentUser.role==='admin' && state.viewMode==='dashboard') setTimeout(renderCharts, 100);
        }

        // --- DASHBOARDS (Admin/User) Functions ... (Same as provided before) ---
        function renderAdminDashboard(c) {
            const pending = state.bookings.filter(b => b.status === 'pending');
            // üî• Approved but not yet done/cancelled
            const approved = state.bookings.filter(b => b.status === 'approved'); 
            
            // Stats logic
            const today = dayjs();
            const todayJobs = state.bookings.filter(b => dayjs(b.startDate).isSame(today, 'day') && !['cancelled', 'rejected'].includes(b.status)).length;
            const activeCars = new Set(state.bookings.filter(b => b.status === 'active' && b.carId).map(b => b.carId._id || b.carId)).size;
            const activeDrivers = new Set(state.bookings.filter(b => b.status === 'active' && b.driverId).map(b => b.driverId._id || b.driverId)).size;

            c.innerHTML = `
            <div class="space-y-6">
                <!-- Summary Cards -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div class="bg-white p-5 rounded-2xl shadow-sm border border-l-4 border-l-blue-500">
                        <div class="text-sm text-gray-500 font-medium">‡∏á‡∏≤‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>
                        <div class="text-3xl font-bold text-gray-800 mt-1">${todayJobs}</div>
                    </div>
                    <div class="bg-white p-5 rounded-2xl shadow-sm border border-l-4 border-l-green-500">
                        <div class="text-sm text-gray-500 font-medium">‡∏£‡∏ñ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πà‡∏á</div>
                        <div class="text-3xl font-bold text-gray-800 mt-1">${activeCars} <span class="text-xs font-normal text-gray-400">‡∏Ñ‡∏±‡∏ô</span></div>
                    </div>
                    <div class="bg-white p-5 rounded-2xl shadow-sm border border-l-4 border-l-purple-500">
                        <div class="text-sm text-gray-500 font-medium">‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô</div>
                        <div class="text-3xl font-bold text-gray-800 mt-1">${activeDrivers} <span class="text-xs font-normal text-gray-400">‡∏Ñ‡∏ô</span></div>
                    </div>
                    <div class="bg-white p-5 rounded-2xl shadow-sm border border-l-4 border-l-yellow-500">
                        <div class="text-sm text-gray-500 font-medium">‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</div>
                        <div class="text-3xl font-bold text-yellow-600 mt-1">${pending.length}</div>
                    </div>
                </div>

                <!-- Charts Area -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="bg-white p-6 rounded-2xl shadow-sm border h-80 flex flex-col">
                        <h4 class="font-bold text-gray-700 mb-4 text-sm flex items-center gap-2"><i data-lucide="bar-chart-2" class="w-4 h-4 text-blue-500"></i> ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏£‡∏ñ (‡∏Ñ‡∏£‡∏±‡πâ‡∏á)</h4>
                        <div class="relative flex-1"><canvas id="carChart"></canvas></div>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-sm border h-80 flex flex-col">
                        <h4 class="font-bold text-gray-700 mb-4 text-sm flex items-center gap-2"><i data-lucide="users" class="w-4 h-4 text-green-500"></i> ‡∏á‡∏≤‡∏ô‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö (‡∏Ñ‡∏£‡∏±‡πâ‡∏á)</h4>
                        <div class="relative flex-1"><canvas id="driverChart"></canvas></div>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-sm border h-80 flex flex-col">
                        <h4 class="font-bold text-gray-700 mb-4 text-sm flex items-center gap-2"><i data-lucide="pie-chart" class="w-4 h-4 text-purple-500"></i> ‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏ú‡∏ô‡∏Å</h4>
                        <div class="relative flex-1"><canvas id="deptChart"></canvas></div>
                    </div>
                </div>

                <!-- Main Operations -->
                <div class="grid lg:grid-cols-3 gap-6">
                    <!-- Left: Approvals -->
                    <div class="lg:col-span-2 space-y-6">
                        <!-- Pending List -->
                        <div class="bg-white p-6 rounded-2xl shadow-sm border">
                            <h3 class="font-bold mb-4 flex items-center gap-2 text-blue-600"><i data-lucide="clock"></i> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ (${pending.length})</h3>
                            ${pending.length===0 
                                ? '<div class="text-center text-gray-400 py-12 border-2 border-dashed border-gray-100 rounded-xl bg-gray-50 flex flex-col items-center gap-2"><i data-lucide="inbox" class="w-10 h-10 opacity-20"></i> ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà</div>' 
                                : `<div class="space-y-3">
                                    ${pending.map(b => `
                                        <div class="border border-gray-200 p-5 rounded-xl bg-white shadow-sm hover:shadow-md transition relative overflow-hidden group">
                                            <div class="absolute left-0 top-0 bottom-0 w-1 bg-yellow-400 group-hover:w-2 transition-all"></div>
                                            <div class="flex flex-col md:flex-row justify-between gap-4">
                                                <div class="flex-1">
                                                    <div class="font-bold text-gray-800 text-lg mb-1">${b.remarks}</div>
                                                    <div class="text-sm text-gray-500 flex items-center gap-2">
                                                        <i data-lucide="calendar" class="w-4 h-4 text-blue-500"></i> 
                                                        ${dayjs(b.startDate).format('DD/MM/YY')} ${b.startTime} - ${dayjs(b.endDate).format('DD/MM/YY')} ${b.endTime}
                                                    </div>
                                                    <div class="mt-2 inline-flex items-center gap-1 bg-gray-100 px-2 py-1 rounded text-xs text-gray-600 font-medium">
                                                        <i data-lucide="user" class="w-3 h-3"></i> ‡∏à‡∏≠‡∏á‡πÇ‡∏î‡∏¢: ${b.userId}
                                                    </div>
                                                </div>
                                                <div class="flex flex-col gap-2 min-w-[220px]">
                                                    <select id="c-${b._id}" class="border border-gray-300 p-2 rounded-lg text-sm bg-gray-50 focus:ring-2 focus:ring-blue-500 outline-none cursor-pointer">
                                                        <option value="">üöò ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏ñ...</option>
                                                        ${state.cars.map(c=>`<option value="${c._id}">${c.name} (${c.plate})</option>`).join('')}
                                                    </select>
                                                    <select id="d-${b._id}" class="border border-gray-300 p-2 rounded-lg text-sm bg-gray-50 focus:ring-2 focus:ring-blue-500 outline-none cursor-pointer">
                                                        <option value="">üë®‚Äç‚úàÔ∏è ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö...</option>
                                                        ${state.drivers.map(d=>`<option value="${d._id}">${d.name}</option>`).join('')}
                                                    </select>
                                                    <div class="flex gap-2 mt-1">
                                                        <button onclick="approveBooking('${b._id}')" class="flex-1 bg-blue-600 text-white py-2 rounded-lg text-sm font-bold shadow-sm hover:bg-blue-700 transition">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
                                                        <button onclick="rejectBooking('${b._id}')" class="flex-1 bg-white border border-red-200 text-red-500 py-2 rounded-lg text-sm font-bold hover:bg-red-50 transition">‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò</button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    `).join('')}
                                  </div>`
                            }
                        </div>

                        <!-- üî• Approved List (Editable) -->
                        <div class="bg-white p-6 rounded-xl shadow-sm border">
                            <h3 class="font-bold mb-4 flex items-center gap-2 text-green-600"><i data-lucide="check-circle"></i> ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß / ‡∏£‡∏≠‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á (${approved.length})</h3>
                            ${approved.length===0 
                                ? '<div class="text-center text-gray-400 py-8 border-2 border-dashed border-gray-100 rounded-xl bg-gray-50">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>' 
                                : `<div class="space-y-3">
                                    ${approved.map(b => `
                                        <div class="border p-4 rounded-xl mb-3 shadow-sm flex justify-between items-center bg-green-50/50 hover:bg-green-50 transition">
                                            <div>
                                                <div class="font-bold text-gray-800">${b.remarks}</div>
                                                <div class="text-xs text-gray-500 flex items-center gap-1 mt-1">
                                                    üìÖ ${dayjs(b.startDate).format('DD/MM/YY')} ${b.startTime} 
                                                    <span class="text-gray-300">|</span> 
                                                    üöò ${b.carId?.name||'-'} 
                                                    <span class="text-gray-300">|</span> 
                                                    üë®‚Äç‚úàÔ∏è ${b.driverId?.name||'-'}
                                                </div>
                                            </div>
                                            <button onclick="openEditBookingModal('${b._id}')" class="text-blue-600 bg-white border border-blue-200 px-3 py-2 rounded-lg hover:bg-blue-50 text-xs font-bold flex items-center gap-1 transition shadow-sm">
                                                <i data-lucide="edit-3" class="w-3 h-3"></i> ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                                            </button>
                                        </div>
                                    `).join('')}
                                  </div>`
                            }
                        </div>
                    </div>
                    
                    <!-- Right: Resource Management -->
                    <div class="space-y-6">
                        <!-- Manage Cars -->
                        <div class="bg-white p-5 rounded-2xl shadow-sm border">
                            <h3 class="font-bold mb-4 flex items-center gap-2 text-gray-800"><div class="bg-blue-100 p-1.5 rounded"><i data-lucide="car" class="text-blue-600 w-4 h-4"></i></div> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏ñ</h3>
                            <form onsubmit="addResource(event,'cars')" class="flex gap-2 mb-4">
                                <input name="name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏∏‡πà‡∏ô" class="border p-2 rounded-lg text-sm flex-1 outline-none focus:border-blue-500" required>
                                <input name="plate" placeholder="‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô" class="border p-2 rounded-lg text-sm w-24 outline-none focus:border-blue-500" required>
                                <button class="bg-blue-600 text-white p-2 rounded-lg hover:bg-blue-700 transition shadow-sm"><i data-lucide="plus" class="w-5 h-5"></i></button>
                            </form>
                            <div class="max-h-64 overflow-y-auto custom-scrollbar pr-1 space-y-2">
                                ${state.cars.map(i=>`
                                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg border border-gray-100 hover:shadow-sm transition group">
                                        <div>
                                            <div class="font-bold text-sm text-gray-800">${i.name}</div>
                                            <div class="text-xs text-gray-500 flex items-center gap-1">
                                                <span class="bg-blue-100 text-blue-700 px-1.5 rounded font-mono">${i.plate}</span> 
                                                <span>‚Ä¢ ${i.currentOdometer?.toLocaleString()||0} km</span>
                                            </div>
                                        </div>
                                        <div class="flex gap-1 opacity-60 group-hover:opacity-100 transition">
                                            <button onclick="openBulkMaintenanceModal('car','${i._id}','${i.name}')" class="text-orange-600 bg-white border border-orange-200 p-1.5 rounded-md hover:bg-orange-50 text-xs flex items-center gap-1 transition font-bold" title="‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°">
                                                <i data-lucide="wrench" class="w-3 h-3"></i> ‡∏´‡∏¢‡∏∏‡∏î/‡∏ã‡πà‡∏≠‡∏°
                                            </button>
                                            <button onclick="deleteResource('cars','${i._id}')" class="text-red-500 bg-white border border-red-200 p-1.5 rounded-md hover:bg-red-50 transition">
                                                <i data-lucide="trash-2" class="w-3 h-3"></i>
                                            </button>
                                        </div>
                                    </div>`).join('')}
                            </div>
                        </div>

                        <!-- Manage Drivers -->
                        <div class="bg-white p-5 rounded-2xl shadow-sm border">
                            <h3 class="font-bold mb-4 flex items-center gap-2 text-gray-800"><div class="bg-green-100 p-1.5 rounded"><i data-lucide="users" class="text-green-600 w-4 h-4"></i></div> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö</h3>
                            <form onsubmit="addResource(event,'drivers')" class="flex gap-2 mb-4">
                                <input name="name" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•" class="border p-2 rounded-lg text-sm flex-1 outline-none focus:border-green-500" required>
                                <input name="phone" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£" class="border p-2 rounded-lg text-sm w-28 outline-none focus:border-green-500" required>
                                <button class="bg-green-600 text-white p-2 rounded-lg hover:bg-green-700 transition shadow-sm"><i data-lucide="plus" class="w-5 h-5"></i></button>
                            </form>
                            <div class="max-h-64 overflow-y-auto custom-scrollbar pr-1 space-y-2">
                                ${state.drivers.map(i=>`
                                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg border border-gray-100 hover:shadow-sm transition group">
                                        <div>
                                            <div class="font-bold text-sm text-gray-800">${i.name}</div>
                                            <div class="text-xs text-gray-500 flex items-center gap-1"><i data-lucide="phone" class="w-3 h-3"></i> ${i.phone}</div>
                                        </div>
                                        <div class="flex gap-1 opacity-60 group-hover:opacity-100 transition">
                                            <button onclick="openBulkMaintenanceModal('driver','${i._id}','${i.name}')" class="text-orange-600 bg-white border border-orange-200 p-1.5 rounded-md hover:bg-orange-50 text-xs flex items-center gap-1 transition font-bold" title="‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î">
                                                <i data-lucide="calendar-off" class="w-3 h-3"></i> ‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î
                                            </button>
                                            <button onclick="deleteResource('drivers','${i._id}')" class="text-red-500 bg-white border border-red-200 p-1.5 rounded-md hover:bg-red-50 transition">
                                                <i data-lucide="trash-2" class="w-3 h-3"></i>
                                            </button>
                                        </div>
                                    </div>`).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            </div>`;
        }

        function renderUserDashboard(c) {
            const today = new Date().toISOString().split('T')[0];
            const myBookings = state.bookings.filter(b => b.userId === state.currentUser.username);
            c.innerHTML = `
            <div class="grid md:grid-cols-12 gap-8">
                <!-- Left: Booking Form -->
                <div class="md:col-span-5 bg-white p-6 rounded-2xl shadow-sm border h-fit sticky top-24">
                    <div class="mb-6 pb-4 border-b border-gray-100">
                        <h2 class="text-xl font-bold flex items-center gap-2 text-gray-800"><div class="bg-blue-100 p-2 rounded-lg text-blue-600"><i data-lucide="plus-circle" class="w-5 h-5"></i></div> ‡∏à‡∏≠‡∏á‡∏£‡∏ñ‡πÉ‡∏´‡∏°‡πà</h2>
                        <p class="text-xs text-gray-500 mt-1 pl-11">‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡πÉ‡∏ä‡πâ‡∏£‡∏ñ</p>
                    </div>
                    
                    <form onsubmit="submitBooking(event)" class="space-y-5">
                        <div class="space-y-3">
                            <div class="grid grid-cols-2 gap-3">
                                <div><label class="text-xs font-bold text-gray-500 block mb-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°</label><input type="date" name="startDate" id="sd" min="${today}" class="w-full border p-2.5 rounded-lg text-sm bg-gray-50 focus:bg-white focus:ring-2 focus:ring-blue-500 outline-none transition" required onchange="checkAvail()"></div>
                                <div><label class="text-xs font-bold text-gray-500 block mb-1">‡πÄ‡∏ß‡∏•‡∏≤</label><input type="time" name="startTime" id="st" class="w-full border p-2.5 rounded-lg text-sm bg-gray-50 focus:bg-white focus:ring-2 focus:ring-blue-500 outline-none transition" required onchange="checkAvail()"></div>
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <div><label class="text-xs font-bold text-gray-500 block mb-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏∑‡∏ô</label><input type="date" name="endDate" id="ed" min="${today}" class="w-full border p-2.5 rounded-lg text-sm bg-gray-50 focus:bg-white focus:ring-2 focus:ring-blue-500 outline-none transition" required onchange="checkAvail()"></div>
                                <div><label class="text-xs font-bold text-gray-500 block mb-1">‡πÄ‡∏ß‡∏•‡∏≤</label><input type="time" name="endTime" id="et" class="w-full border p-2.5 rounded-lg text-sm bg-gray-50 focus:bg-white focus:ring-2 focus:ring-blue-500 outline-none transition" required onchange="checkAvail()"></div>
                            </div>
                        </div>

                        <!-- Availability Badge -->
                        <div id="avail-badge" class="hidden p-4 bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-100 rounded-xl text-center shadow-inner transition-all duration-300">
                            <div class="text-xs font-bold text-blue-800 mb-2 uppercase tracking-wide">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏° (‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏µ‡πâ)</div>
                            <div class="flex justify-center gap-8 text-sm">
                                <div class="flex flex-col items-center">
                                    <span class="text-2xl font-black text-blue-600" id="cc">0</span>
                                    <span class="text-xs text-gray-600 font-medium flex items-center gap-1"><i data-lucide="car" class="w-3 h-3"></i> ‡∏£‡∏ñ‡∏ß‡πà‡∏≤‡∏á</span>
                                </div>
                                <div class="w-px bg-blue-200 h-8 self-center"></div>
                                <div class="flex flex-col items-center">
                                    <span class="text-2xl font-black text-green-600" id="dc">0</span>
                                    <span class="text-xs text-gray-600 font-medium flex items-center gap-1"><i data-lucide="user" class="w-3 h-3"></i> ‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex items-center gap-3 bg-gray-50 p-3 rounded-xl border border-gray-100 hover:border-blue-200 transition cursor-pointer" onclick="document.getElementById('ud').click()">
                            <input type="checkbox" name="useDriver" id="ud" class="w-5 h-5 text-blue-600 rounded focus:ring-blue-500 cursor-pointer">
                            <label for="ud" class="text-sm font-bold text-gray-700 cursor-pointer select-none">‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö‡∏£‡∏ñ</label>
                        </div>
                        
                        <div>
                            <label class="text-xs font-bold text-gray-500 block mb-1">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á</label>
                            <textarea name="remarks" class="w-full border p-3 rounded-xl text-sm bg-gray-50 focus:bg-white focus:ring-2 focus:ring-blue-500 outline-none transition" rows="3" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà, ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡πÇ‡∏î‡∏¢‡∏™‡∏≤‡∏£, ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠..." required></textarea>
                        </div>
                        
                        <button class="w-full bg-blue-600 text-white p-3.5 rounded-xl font-bold shadow-lg hover:bg-blue-700 hover:shadow-xl transition-all transform active:scale-95 flex items-center justify-center gap-2">
                            <span>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</span> <i data-lucide="arrow-right" class="w-4 h-4"></i>
                        </button>
                    </form>
                </div>

                <!-- Right: Booking History -->
                <div class="md:col-span-7 space-y-4">
                    <div class="bg-white p-6 rounded-2xl shadow-sm border">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="font-bold text-lg text-gray-800">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</h3>
                            <span class="text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded-full">${myBookings.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
                        </div>
                        
                        ${myBookings.length===0 
                            ? `<div class="text-center text-gray-400 py-12 border-2 border-dashed border-gray-100 rounded-xl bg-gray-50">
                                <i data-lucide="calendar-off" class="w-10 h-10 mx-auto mb-2 opacity-30"></i>
                                ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á
                               </div>` 
                            : `<div class="space-y-3">
                                ${myBookings.map(b => `
                                    <div class="border border-gray-100 p-5 rounded-2xl bg-white hover:shadow-md transition group relative overflow-hidden">
                                        <div class="flex justify-between items-start relative z-10">
                                            <div>
                                                <div class="flex items-center gap-2 mb-2">
                                                    <span class="px-2.5 py-0.5 rounded-full text-[10px] font-bold uppercase tracking-wide border status-${b.status} bg-opacity-10 text-opacity-80 border-opacity-20" style="color:var(--status-color); border-color:var(--status-color);">
                                                        ${b.status}
                                                    </span>
                                                    <span class="text-xs text-gray-400 font-mono">${dayjs(b.createdAt).format('DD/MM/YY')}</span>
                                                </div>
                                                <div class="font-bold text-lg text-gray-800 group-hover:text-blue-600 transition">${b.remarks}</div>
                                                <div class="text-sm text-gray-500 flex items-center gap-2 mt-1">
                                                    <i data-lucide="calendar" class="w-4 h-4 text-blue-400"></i> 
                                                    <span class="font-medium text-gray-700">${dayjs(b.startDate).format('DD/MM')}</span> ${b.startTime} 
                                                    <i data-lucide="arrow-right" class="w-3 h-3 text-gray-300"></i> 
                                                    <span class="font-medium text-gray-700">${dayjs(b.endDate).format('DD/MM')}</span> ${b.endTime}
                                                </div>
                                                ${b.carId ? `<div class="mt-3 inline-flex items-center gap-2 text-xs bg-gray-50 border px-3 py-1.5 rounded-lg text-gray-600"><i data-lucide="car" class="w-3 h-3"></i> ${b.carId.name} ${b.driverId ? `<span class="text-gray-300">|</span> <i data-lucide="user" class="w-3 h-3"></i> ${b.driverId.name}` : ''}</div>` : ''}
                                            </div>
                                            <div class="flex flex-col gap-2 items-end pt-1">
                                                ${b.status==='approved' ? `<button onclick="startTrip('${b._id}')" class="bg-green-600 text-white px-4 py-1.5 rounded-lg text-xs font-bold shadow hover:bg-green-700 flex items-center gap-1 transition transform hover:scale-105">üöÄ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô</button>` : ''}
                                                ${b.status==='active' ? `<button onclick="endTrip('${b._id}', ${b.startOdometer})" class="bg-gray-800 text-white px-4 py-1.5 rounded-lg text-xs font-bold shadow hover:bg-black flex items-center gap-1 transition transform hover:scale-105">üèÅ ‡∏Ñ‡∏∑‡∏ô‡∏£‡∏ñ</button>` : ''}
                                                ${['pending','approved'].includes(b.status) ? `<button onclick="cancelBooking('${b._id}')" class="text-red-500 text-xs font-medium hover:text-red-700 hover:underline px-2 py-1">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>` : ''}
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                               </div>`
                        }
                    </div>
                </div>
            </div>`;
        }

        // --- VIEW: HISTORY & EDIT ---
        function renderHistoryView(c) {
            const list = state.bookings.sort((a,b)=>new Date(b.startDate)-new Date(a.startDate));
            c.innerHTML = `
            <div class="bg-white p-6 rounded-2xl shadow-sm border">
                <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                    <h3 class="font-bold text-xl flex items-center gap-2 text-gray-800"><div class="bg-indigo-100 p-2 rounded-lg text-indigo-600"><i data-lucide="file-text"></i></div> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô & ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</h3>
                    <button onclick="exportCSV()" class="bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2 shadow hover:bg-green-700 transition"><i data-lucide="download"></i> Export CSV</button>
                </div>
                <div class="overflow-x-auto rounded-xl border border-gray-200">
                    <table class="w-full text-left text-sm border-collapse">
                        <thead class="bg-gray-50 text-gray-600 font-bold text-xs uppercase tracking-wider">
                            <tr>
                                <th class="p-4 border-b">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà / ‡πÄ‡∏ß‡∏•‡∏≤</th>
                                <th class="p-4 border-b">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th>
                                <th class="p-4 border-b">‡∏£‡∏ñ / ‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö</th>
                                <th class="p-4 border-b text-right">‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå (km)</th>
                                <th class="p-4 border-b text-right">‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢ (‡∏ö‡∏≤‡∏ó)</th>
                                <th class="p-4 border-b text-center">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                <th class="p-4 border-b text-right">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-100">
                            ${list.map(b => {
                                const u = state.users.find(x=>x.username===b.userId)||{firstName:b.userId};
                                const dist = (b.endOdometer && b.startOdometer) ? (b.endOdometer - b.startOdometer).toLocaleString() : '-';
                                return `
                                <tr class="hover:bg-gray-50 transition group">
                                    <td class="p-4 align-top">
                                        <div class="font-bold text-gray-800">${dayjs(b.startDate).format('DD/MM/YY')}</div>
                                        <div class="text-xs text-gray-500 font-mono mt-1">${b.startTime} - ${b.endTime}</div>
                                    </td>
                                    <td class="p-4 align-top">
                                        <div class="font-medium text-gray-900 line-clamp-2" title="${b.remarks}">${b.remarks}</div>
                                        <div class="text-xs text-gray-500 mt-1 flex items-center gap-1"><i data-lucide="user" class="w-3 h-3"></i> ${u.firstName}</div>
                                    </td>
                                    <td class="p-4 align-top">
                                        <div class="text-xs font-medium text-blue-700 bg-blue-50 px-2 py-0.5 rounded inline-block mb-1">üöò ${b.carId?.name||'-'}</div>
                                        <div class="text-xs font-medium text-green-700 bg-green-50 px-2 py-0.5 rounded inline-block">üë®‚Äç‚úàÔ∏è ${b.driverId?.name||'-'}</div>
                                    </td>
                                    <td class="p-4 align-top text-right">
                                        <div class="text-gray-900 font-mono text-xs">Start: <span class="font-bold">${b.startOdometer?.toLocaleString()||'-'}</span></div>
                                        <div class="text-gray-900 font-mono text-xs">End: <span class="font-bold">${b.endOdometer?.toLocaleString()||'-'}</span></div>
                                        ${dist!=='-'?`<div class="text-[10px] text-blue-600 font-bold mt-1 bg-blue-50 inline-block px-1 rounded">+${dist} km</div>`:''}
                                    </td>
                                    <td class="p-4 align-top text-right text-xs">
                                        <div>‚õΩ ${b.fuelCost?.toLocaleString()||0}</div>
                                        <div>üõ£Ô∏è ${b.tollCost?.toLocaleString()||0}</div>
                                        <div class="border-t mt-1 pt-1 font-bold text-gray-700">Total: ${((b.fuelCost||0)+(b.tollCost||0)).toLocaleString()}</div>
                                    </td>
                                    <td class="p-4 align-top text-center">
                                        <span class="px-2.5 py-1 rounded-full text-[10px] font-bold uppercase status-${b.status} text-white shadow-sm border border-white border-opacity-20">${b.status}</span>
                                    </td>
                                    <td class="p-4 align-top text-right">
                                        ${state.currentUser.role==='admin' ? `<button onclick="openEditBookingModal('${b._id}')" class="text-blue-600 bg-white border border-blue-200 p-2 rounded-lg hover:bg-blue-50 transition shadow-sm" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"><i data-lucide="edit-3" class="w-4 h-4"></i></button>` : ''}
                                    </td>
                                </tr>`;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            </div>`;
        }

        function renderCalendar(c) {
            const now = dayjs(state.currentDate);
            const monthStart = now.startOf('month');
            const monthEnd = now.endOf('month');
            const start = monthStart.startOf('week');
            const end = monthEnd.endOf('week');
            let days = []; let d = start;

            while (d.isBefore(end) || d.isSame(end, 'day')) {
                const dateStr = d.format('D');
                const isCurr = d.isSame(dayjs(), 'day');
                const isOther = !d.isSame(monthStart, 'month');
                const events = state.bookings.filter(b => dayjs(b.startDate).isSame(d, 'day') && b.status !== 'cancelled');
                
                days.push(`
                    <div class="calendar-day ${isOther?'other-month':''}">
                        <div class="text-right text-xs font-bold mb-1 p-2">
                            <span class="${isCurr?'bg-blue-600 text-white w-7 h-7 rounded-full inline-flex items-center justify-center shadow-md':''}">${dateStr}</span>
                        </div>
                        <div class="flex-1 overflow-hidden space-y-1 px-1">
                            ${events.map(b => {
                                let display = `${b.startTime} ${b.remarks}`;
                                // üî• Improved Display for Maintenance
                                if(b.status === 'maintenance') {
                                    const res = b.carId ? `üöò ${b.carId.plate||b.carId.name}` : (b.driverId ? `üë®‚Äç‚úàÔ∏è ${b.driverId.name}` : '');
                                    display = `${res} [‡∏õ‡∏¥‡∏î] ${b.remarks.replace('[‡∏õ‡∏¥‡∏î]', '')}`;
                                }
                                return `<div onclick="showBookingDetails('${b._id}')" class="event-pill status-${b.status} shadow-sm" title="${display}">${display}</div>`;
                            }).join('')}
                        </div>
                    </div>`);
                d = d.add(1, 'day');
            }
            c.innerHTML = `
            <div class="bg-white p-6 rounded-2xl shadow-sm border h-full flex flex-col">
                <div class="flex justify-between items-center mb-6">
                    <div class="flex gap-2">
                        <button onclick="changeMonth(-1)" class="p-2 hover:bg-gray-100 rounded-lg"><i data-lucide="chevron-left"></i></button>
                        <button onclick="state.currentDate=new Date();renderApp()" class="px-3 text-sm font-bold hover:text-blue-600 transition">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</button>
                        <button onclick="changeMonth(1)" class="p-2 hover:bg-gray-100 rounded-lg"><i data-lucide="chevron-right"></i></button>
                    </div>
                    <div class="font-bold text-xl text-gray-800">${now.format('MMMM YYYY')}</div>
                </div>
                <div class="border rounded-xl overflow-hidden flex flex-col flex-1 shadow-sm">
                    <div class="grid grid-cols-7 bg-gray-50 border-b text-center text-xs font-bold text-gray-500 py-3 uppercase tracking-wider"><div>‡∏≠‡∏≤</div><div>‡∏à</div><div>‡∏≠</div><div>‡∏û</div><div>‡∏û‡∏§</div><div>‡∏®</div><div>‡∏™</div></div>
                    <div class="grid grid-cols-7 flex-1 bg-gray-100 gap-px border-l border-t">${days.join('')}</div>
                </div>
                <div class="mt-5 flex flex-wrap gap-4 text-xs text-gray-600 justify-center">
                    <div class="flex items-center gap-1.5"><span class="w-3 h-3 rounded-full status-pending"></span> ‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</div>
                    <div class="flex items-center gap-1.5"><span class="w-3 h-3 rounded-full status-approved"></span> ‡∏à‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß</div>
                    <div class="flex items-center gap-1.5"><span class="w-3 h-3 rounded-full status-active"></span> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ</div>
                    <div class="flex items-center gap-1.5"><span class="w-3 h-3 rounded-full status-completed"></span> ‡∏à‡∏ö‡∏á‡∏≤‡∏ô</div>
                    <div class="flex items-center gap-1.5"><span class="w-3 h-3 rounded-full status-maintenance"></span> ‡∏ã‡πà‡∏≠‡∏°/‡∏´‡∏¢‡∏∏‡∏î</div>
                </div>
            </div>`;
        }

        function renderUserManagement(c) {
            c.innerHTML = `
            <div class="bg-white p-6 rounded-xl shadow-sm border">
                <h3 class="font-bold mb-4 text-lg flex items-center gap-2"><i data-lucide="users" class="text-purple-600"></i> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h3>
                <form onsubmit="addUser(event)" class="grid grid-cols-1 md:grid-cols-6 gap-3 mb-8 bg-purple-50 p-5 rounded-2xl border border-purple-100 shadow-sm">
                    <input name="username" placeholder="Username" class="border p-2.5 rounded-lg text-sm bg-white outline-none focus:ring-2 focus:ring-purple-500" required>
                    <input name="password" placeholder="Password" class="border p-2.5 rounded-lg text-sm bg-white outline-none focus:ring-2 focus:ring-purple-500" required>
                    <input name="firstName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏£‡∏¥‡∏á" class="border p-2.5 rounded-lg text-sm bg-white outline-none focus:ring-2 focus:ring-purple-500" required>
                    <input name="lastName" placeholder="‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•" class="border p-2.5 rounded-lg text-sm bg-white outline-none focus:ring-2 focus:ring-purple-500" required>
                    <input name="email" placeholder="Email" class="border p-2.5 rounded-lg text-sm bg-white outline-none focus:ring-2 focus:ring-purple-500">
                    <select name="department" class="border p-2.5 rounded-lg text-sm bg-white outline-none focus:ring-2 focus:ring-purple-500 cursor-pointer"><option value="">‡πÅ‡∏ú‡∏ô‡∏Å...</option>${DEPARTMENTS.map(d=>`<option value="${d}">${d}</option>`).join('')}</select>
                    <button class="bg-purple-600 text-white px-4 py-2.5 rounded-lg text-sm font-bold md:col-span-6 hover:bg-purple-700 shadow-md transition transform active:scale-95">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡∏°‡πà</button>
                </form>
                <div class="overflow-x-auto rounded-xl border border-gray-200">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-gray-50 text-gray-500 font-bold text-xs uppercase"><tr><th class="p-4">User</th><th class="p-4">Name</th><th class="p-4">Dept</th><th class="p-4">Status</th><th class="p-4 text-right">Actions</th></tr></thead>
                        <tbody>
                            ${state.users.map(u => `
                            <tr class="hover:bg-gray-50 transition ${!u.isActive?'bg-gray-100 opacity-60':''}">
                                <td class="p-4 font-bold text-gray-700">${u.username}</td>
                                <td class="p-4 text-gray-600">${u.firstName} ${u.lastName}</td>
                                <td class="p-4"><span class="bg-purple-50 text-purple-700 px-2.5 py-1 rounded-md text-xs font-medium border border-purple-100">${u.department}</span></td>
                                <td class="p-4">${u.lineUserId ? '<span class="text-green-600 flex gap-1 items-center font-bold text-xs"><i data-lucide="check-circle" class="w-3 h-3"></i> Linked</span>' : '<span class="text-gray-400 text-xs flex gap-1 items-center"><i data-lucide="circle" class="w-3 h-3"></i> Unlinked</span>'}</td>
                                <td class="p-4 text-right flex justify-end gap-1">
                                    <button onclick="openEditUserModal('${u._id}')" class="bg-white border border-gray-200 text-gray-500 p-2 rounded-lg hover:bg-blue-50 hover:text-blue-600 hover:border-blue-200 transition" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç"><i data-lucide="edit" class="w-4 h-4"></i></button>
                                    <button onclick="openResetPwdModal('${u._id}','${u.username}')" class="bg-white border border-gray-200 text-gray-500 p-2 rounded-lg hover:bg-yellow-50 hover:text-yellow-600 hover:border-yellow-200 transition" title="‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏û‡∏≤‡∏™"><i data-lucide="key" class="w-4 h-4"></i></button>
                                    <button onclick="toggleUser('${u._id}', ${u.isActive})" class="border p-1.5 rounded text-xs w-8 ${u.isActive?'text-green-600 border-green-200 bg-green-50':'text-gray-400 border-gray-300 hover:bg-gray-100'}" title="‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞">${u.isActive?'ON':'OFF'}</button>
                                    ${u.lineUserId ? `<button onclick="unlinkLine('${u._id}')" class="bg-white border border-gray-200 text-gray-500 p-2 rounded-lg hover:bg-gray-100 transition" title="‡∏õ‡∏•‡∏î‡πÑ‡∏•‡∏ô‡πå"><i data-lucide="unlink" class="w-4 h-4"></i></button>` : ''}
                                    <button onclick="deleteResource('users','${u._id}')" class="bg-white border border-gray-200 text-gray-400 p-2 rounded-lg hover:bg-red-50 hover:text-red-500 hover:border-red-200 transition"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                </td>
                            </tr>`).join('')}
                        </tbody>
                    </table>
                </div>
            </div>`;
        }

        // --- MODALS HTML ---
        function renderModals() {
            document.getElementById('modals-container').innerHTML = `
                <!-- Change Pwd -->
                <div id="changePwdModal" class="modal fixed inset-0 bg-black/70 flex items-center justify-center p-4"><div class="bg-white p-6 rounded-2xl w-full max-w-sm modal-content shadow-2xl"><h3 class="font-bold mb-4 text-lg">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</h3><form onsubmit="handleChangePwdSubmit(event)" class="space-y-4"><input type="password" name="oldPassword" placeholder="‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏î‡∏¥‡∏°" class="w-full border p-3 rounded-lg bg-gray-50" required><input type="password" name="newPassword" placeholder="‡∏£‡∏´‡∏±‡∏™‡πÉ‡∏´‡∏°‡πà" class="w-full border p-3 rounded-lg bg-gray-50" required><div class="flex justify-end gap-3 mt-6"><button type="button" onclick="closeModal()" class="text-gray-500 hover:bg-gray-100 px-4 py-2 rounded-lg">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button><button class="bg-blue-600 text-white px-6 py-2 rounded-lg font-bold">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button></div></form></div></div>
                <!-- Reset Pwd Admin -->
                <div id="resetPwdModal" class="modal fixed inset-0 bg-black/70 flex items-center justify-center p-4"><div class="bg-white p-6 rounded-2xl w-full max-w-sm modal-content shadow-2xl"><h3 class="font-bold mb-4 text-lg text-yellow-600 flex items-center gap-2"><i data-lucide="key"></i> ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô User</h3><form onsubmit="handleResetPwd(event)" class="space-y-4"><input type="password" name="password" placeholder="‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏´‡πâ User" class="w-full border p-3 rounded-lg bg-yellow-50 focus:ring-yellow-500 border-yellow-200" required><div class="flex justify-end gap-3 mt-6"><button type="button" onclick="closeModal()" class="text-gray-500 hover:bg-gray-100 px-4 py-2 rounded-lg transition">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button><button class="bg-yellow-500 text-white px-6 py-2 rounded-lg font-bold hover:bg-yellow-600 shadow-md">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï</button></div></form></div></div>
                <!-- Edit User -->
                <div id="editUserModal" class="modal fixed inset-0 bg-black/70 flex items-center justify-center p-4"><div class="bg-white p-6 rounded-2xl w-full max-w-md modal-content shadow-2xl"><h3 class="font-bold mb-6 text-lg">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</h3><form onsubmit="handleEditUserSubmit(event)" class="space-y-4"><div class="grid grid-cols-2 gap-4"><input id="eu-fn" name="firstName" placeholder="‡∏ä‡∏∑‡πà‡∏≠" class="w-full border p-3 rounded-lg" required><input id="eu-ln" name="lastName" placeholder="‡∏™‡∏Å‡∏∏‡∏•" class="w-full border p-3 rounded-lg" required></div><select id="eu-dept" name="department" class="w-full border p-3 rounded-lg bg-white" required>${DEPARTMENTS.map(d=>`<option value="${d}">${d}</option>`).join('')}</select><input id="eu-email" name="email" placeholder="Email (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)" class="w-full border p-3 rounded-lg"><div class="flex justify-end gap-3 mt-6"><button type="button" onclick="closeModal()" class="text-gray-500 hover:text-gray-700 px-3 py-2">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button><button class="bg-blue-600 text-white px-6 py-2 rounded-lg font-bold">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button></div></form></div></div>
                <!-- Edit Booking -->
                <div id="editBookingModal" class="modal fixed inset-0 bg-black/70 flex items-center justify-center p-4"><div class="bg-white p-6 rounded-2xl w-full max-w-md modal-content shadow-2xl"><h3 class="font-bold mb-6 text-blue-600 text-lg flex items-center gap-2"><i data-lucide="edit-3"></i> ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏á‡∏≤‡∏ô‡∏à‡∏≠‡∏á</h3><form onsubmit="handleEditBookingSubmit(event)" class="space-y-4"><div><label class="text-xs font-bold text-gray-500">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏ñ</label><select id="eb-car" class="w-full border p-2.5 rounded-lg text-sm"></select></div><div><label class="text-xs font-bold text-gray-500">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö</label><select id="eb-driver" class="w-full border p-2.5 rounded-lg text-sm"></select></div><div class="grid grid-cols-2 gap-4"><div><label class="text-xs font-bold text-gray-500">‡πÑ‡∏°‡∏•‡πå‡πÄ‡∏£‡∏¥‡πà‡∏°</label><input type="number" id="eb-s-odo" class="w-full border p-2 rounded-lg text-sm"></div><div><label class="text-xs font-bold text-gray-500">‡πÑ‡∏°‡∏•‡πå‡∏à‡∏ö</label><input type="number" id="eb-e-odo" class="w-full border p-2 rounded-lg text-sm"></div></div><div class="grid grid-cols-2 gap-4"><div><label class="text-xs font-bold text-gray-500">‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô (‡∏ö‡∏≤‡∏ó)</label><input type="number" id="eb-fuel" class="w-full border p-2 rounded-lg text-sm"></div><div><label class="text-xs font-bold text-gray-500">‡∏ó‡∏≤‡∏á‡∏î‡πà‡∏ß‡∏ô (‡∏ö‡∏≤‡∏ó)</label><input type="number" id="eb-toll" class="w-full border p-2 rounded-lg text-sm"></div></div><div class="flex justify-end gap-3 mt-6"><button type="button" onclick="closeModal()" class="text-gray-500">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button><button class="bg-blue-600 text-white px-6 py-2 rounded-lg font-bold">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button></div></form></div></div>
                <!-- üî• Bulk Maintenance Modal -->
                <div id="bulkMaintenanceModal" class="modal fixed inset-0 bg-black/80 flex items-center justify-center p-4"><div class="bg-white p-6 rounded-2xl w-full max-w-2xl modal-content flex flex-col h-[90vh]"><div class="flex justify-between items-center mb-4"><h3 class="font-bold text-xl text-orange-600 flex items-center gap-2"><i data-lucide="calendar-off"></i> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î/‡∏ã‡πà‡∏≠‡∏°</h3><button onclick="closeModal()" class="text-gray-400 hover:text-gray-600"><i data-lucide="x"></i></button></div><div class="flex items-center justify-between mb-4 bg-gray-50 p-2 rounded-lg"><button onclick="bulkState.currentMonth=bulkState.currentMonth.subtract(1,'month');renderBulkCalendar()" class="p-2 hover:bg-white rounded"><i data-lucide="chevron-left"></i></button><span id="bulk-month-label" class="font-bold text-lg"></span><button onclick="bulkState.currentMonth=bulkState.currentMonth.add(1,'month');renderBulkCalendar()" class="p-2 hover:bg-white rounded"><i data-lucide="chevron-right"></i></button></div><div class="grid grid-cols-7 gap-2 mb-2 text-center text-xs font-bold text-gray-500 uppercase"><div onclick="toggleBulkDayColumn(0)" class="bulk-header hover:text-orange-500">‡∏≠‡∏≤</div><div onclick="toggleBulkDayColumn(1)" class="bulk-header hover:text-orange-500">‡∏à</div><div onclick="toggleBulkDayColumn(2)" class="bulk-header hover:text-orange-500">‡∏≠</div><div onclick="toggleBulkDayColumn(3)" class="bulk-header hover:text-orange-500">‡∏û</div><div onclick="toggleBulkDayColumn(4)" class="bulk-header hover:text-orange-500">‡∏û‡∏§</div><div onclick="toggleBulkDayColumn(5)" class="bulk-header hover:text-orange-500">‡∏®</div><div onclick="toggleBulkDayColumn(6)" class="bulk-header hover:text-orange-500">‡∏™</div></div><div id="bulk-calendar-grid" class="grid grid-cols-7 gap-2 flex-1 overflow-y-auto p-1"></div><div class="mt-4 pt-4 border-t space-y-3"><input id="bulk-remark" class="w-full border p-3 rounded-lg text-sm" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏ (‡πÄ‡∏ä‡πà‡∏ô ‡∏õ‡∏¥‡∏î‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏õ‡∏µ, ‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏£‡πâ‡∏≠‡∏ô)"><div class="flex justify-end gap-3"><button onclick="closeModal()" class="px-4 py-2 text-gray-500 hover:bg-gray-100 rounded-lg">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button><button onclick="submitBulkMaintenance()" class="px-6 py-2 bg-orange-600 text-white rounded-lg font-bold hover:bg-orange-700">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á</button></div></div></div></div>
            `;
        }

        // --- BULK LOGIC ---
        function openBulkMaintenanceModal(type, id, name) {
            bulkState = { ...bulkState, resourceType: type, resourceId: id, resourceName: name, selectedDates: new Set() };
            // Pre-select dates
            state.bookings.forEach(b => {
                if (b.status === 'maintenance') {
                    if ((type === 'car' && b.carId?._id === id) || (type === 'driver' && b.driverId?._id === id)) {
                        bulkState.selectedDates.add(b.startDate);
                    }
                }
            });
            document.getElementById('bulk-remark').value = '';
            renderBulkCalendar();
            openModal('bulkMaintenanceModal');
        }

        function renderBulkCalendar() {
            const start = bulkState.currentMonth.startOf('month').startOf('week');
            const end = bulkState.currentMonth.endOf('month').endOf('week');
            const grid = document.getElementById('bulk-calendar-grid');
            document.getElementById('bulk-month-label').innerText = bulkState.currentMonth.format('MMMM YYYY');
            grid.innerHTML = '';

            let day = start;
            while (day.isBefore(end)) {
                const dateStr = day.format('YYYY-MM-DD');
                const isSelected = bulkState.selectedDates.has(dateStr);
                const isCurrentMonth = day.isSame(bulkState.currentMonth, 'month');
                
                const hasConflict = state.bookings.some(b => 
                    b.status !== 'maintenance' && b.status !== 'cancelled' && b.status !== 'rejected' &&
                    dayjs(b.startDate).isSame(day, 'day') &&
                    ((bulkState.resourceType==='car' && b.carId?._id===bulkState.resourceId) || (bulkState.resourceType==='driver' && b.driverId?._id===bulkState.resourceId))
                );

                const el = document.createElement('div');
                el.className = `bulk-day ${isSelected ? 'selected' : ''} ${hasConflict ? 'has-conflict' : ''} ${!isCurrentMonth ? 'opacity-30' : ''}`;
                el.innerHTML = `<span class="text-sm">${day.date()}</span>${hasConflict ? '<div class="dot-indicator dot-conflict"></div>' : ''}`;
                // üî• Allow selecting even if conflict exists (Admin Override)
                el.onclick = () => toggleBulkDate(dateStr);
                
                grid.appendChild(el);
                day = day.add(1, 'day');
            }
        }

        function toggleBulkDate(dateStr) {
            if (bulkState.selectedDates.has(dateStr)) bulkState.selectedDates.delete(dateStr);
            else bulkState.selectedDates.add(dateStr);
            renderBulkCalendar();
        }

        function toggleBulkDayColumn(dayIndex) {
            let day = bulkState.currentMonth.startOf('month');
            const end = bulkState.currentMonth.endOf('month');
            while (day.day() !== dayIndex) day = day.add(1, 'day'); // Find first occurence

            let allSelected = true;
            const daysInCol = [];
            while (day.isBefore(end) || day.isSame(end, 'day')) {
                const ds = day.format('YYYY-MM-DD');
                daysInCol.push(ds);
                if (!bulkState.selectedDates.has(ds)) allSelected = false;
                day = day.add(7, 'day');
            }

            daysInCol.forEach(d => {
                // Allow bulk select regardless of conflict
                if(allSelected) bulkState.selectedDates.delete(d);
                else bulkState.selectedDates.add(d);
            });
            renderBulkCalendar();
        }

        async function submitBulkMaintenance() {
            const remark = document.getElementById('bulk-remark').value || '‡∏õ‡∏¥‡∏î‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á';
            const selectedArray = Array.from(bulkState.selectedDates);
            const currentMaintenance = state.bookings.filter(b => 
                b.status === 'maintenance' && 
                ((bulkState.resourceType==='car' && b.carId?._id===bulkState.resourceId) || (bulkState.resourceType==='driver' && b.driverId?._id===bulkState.resourceId))
            );
            const currentDates = new Set(currentMaintenance.map(b => b.startDate));

            const toAdd = selectedArray.filter(d => !currentDates.has(d));
            const toRemove = currentMaintenance.filter(b => !bulkState.selectedDates.has(b.startDate));

            try {
                for (const b of toRemove) await api.action('delete', `bookings/${b._id}`);
                for (const d of toAdd) {
                    await api.action('post', 'bookings', {
                        startDate: d, startTime: '00:00', endDate: d, endTime: '23:59',
                        status: 'maintenance', remarks: `[‡∏õ‡∏¥‡∏î] ${remark}`,
                        userId: state.currentUser.username, // üî• FIX: Send correct admin ID
                        carId: bulkState.resourceType==='car' ? bulkState.resourceId : null,
                        driverId: bulkState.resourceType==='driver' ? bulkState.resourceId : null
                    });
                }
                Swal.fire('Success', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
                closeModal();
                api.fetchData();
            } catch (e) { Swal.fire('Error', e.message, 'error'); }
        }

        // --- ACTIONS ---
        async function checkAvail() { const sd=document.getElementById('sd').value, st=document.getElementById('st').value, ed=document.getElementById('ed').value, et=document.getElementById('et').value, badge=document.getElementById('avail-badge'); if(sd&&st&&ed&&et){const r=await api.action('post','check-availability',{startDate:sd,startTime:st,endDate:ed,endTime:et}); if(r.success){document.getElementById('cc').innerText=r.data.availableCars.length;document.getElementById('dc').innerText=r.data.availableDrivers.length;badge.classList.remove('hidden');}}else badge.classList.add('hidden'); }
        
        // üî•üî• BUG FIX: Added Check for Success/Fail
        async function submitBooking(e){ 
            e.preventDefault(); 
            const d = Object.fromEntries(new FormData(e.target)); 
            d.useDriver = document.getElementById('ud').checked; 
            
            // Show loading
            const btn = e.target.querySelector('button');
            const oldText = btn.innerHTML;
            btn.innerHTML = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
            btn.disabled = true;

            const res = await api.action('post','bookings',d); 
            
            if (res.success) {
                Swal.fire('Success', '‡∏à‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠ Admin ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥', 'success');
                api.fetchData();
                e.target.reset(); // Clear Form
                document.getElementById('avail-badge').classList.add('hidden');
            } else {
                Swal.fire('Error', res.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á', 'error');
            }

            btn.innerHTML = oldText;
            btn.disabled = false;
        }

        async function approveBooking(id){ const c=document.getElementById(`c-${id}`).value, d=document.getElementById(`d-${id}`).value; if(!c)return Swal.fire('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏ñ'); await api.action('put',`bookings/${id}`,{status:'approved',carId:c,driverId:d}); api.fetchData(); }
        async function rejectBooking(id){ await api.action('put',`bookings/${id}`,{status:'rejected'}); api.fetchData(); }
        async function startTrip(id){ const b=state.bookings.find(x=>x._id===id); let co=0; if(b.carId){const r=await axios.get(`${API_URL}/cars`);const c=r.data.find(x=>x._id===(b.carId._id||b.carId));if(c)co=c.currentOdometer||0;} const {value:v}=await Swal.fire({title:'‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á',html:`<div class="text-left bg-blue-50 p-3 rounded mb-2">‡πÑ‡∏°‡∏•‡πå‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: <b>${co.toLocaleString()}</b></div><input id="sw1" type="number" class="swal2-input" value="${co}">`,preConfirm:()=>{const v=document.getElementById('sw1').value;if(v<co)Swal.showValidationMessage('‡∏´‡πâ‡∏≤‡∏°‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°');return v;}}); if(v){await api.action('put',`bookings/${id}`,{status:'active',startOdometer:v});api.fetchData();} }
        async function endTrip(id,so){ const {value:f}=await Swal.fire({title:'‡∏Ñ‡∏∑‡∏ô‡∏£‡∏ñ',html:`<input id="eo" placeholder="‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå‡∏à‡∏ö > ${so}" class="swal2-input"><input id="ef" placeholder="‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô" class="swal2-input"><input id="et" placeholder="‡∏ó‡∏≤‡∏á‡∏î‡πà‡∏ß‡∏ô" class="swal2-input">`,preConfirm:()=>{return {endOdometer:document.getElementById('eo').value, fuelCost:document.getElementById('ef').value, tollCost:document.getElementById('et').value}}}); if(f){if(Number(f.endOdometer)<=Number(so))return Swal.fire('Error','‡πÑ‡∏°‡∏•‡πå‡∏à‡∏ö‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤','error'); await api.action('put',`bookings/${id}`,{status:'completed',...f});api.fetchData();} }
        async function addResource(e,t){ e.preventDefault(); await api.action('post',t,Object.fromEntries(new FormData(e.target))); api.fetchData(); e.target.reset(); }
        async function deleteResource(t,id){ if((await Swal.fire({title:'‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö?',showCancelButton:true,confirmButtonColor:'#ef4444'})).isConfirmed){ await api.action('delete',`${t}/${id}`); api.fetchData(); } }
        async function addUser(e){ e.preventDefault(); await api.action('post','users',Object.fromEntries(new FormData(e.target))); api.fetchData(); e.target.reset(); }
        
        function openEditUserModal(id){ const u=state.users.find(x=>x._id===id); modalData=u; document.getElementById('eu-fn').value=u.firstName; document.getElementById('eu-ln').value=u.lastName; document.getElementById('eu-dept').value=u.department; document.getElementById('eu-email').value=u.email; openModal('editUserModal'); }
        async function handleEditUserSubmit(e){ e.preventDefault(); await api.action('put',`users/${modalData._id}`,Object.fromEntries(new FormData(e.target))); closeModal(); api.fetchData(); }
        function openResetPwdModal(id,u){ modalData={id,username:u}; openModal('resetPwdModal'); }
        async function handleResetPwd(e){ e.preventDefault(); await api.action('put',`users/${modalData.id}`,{password:new FormData(e.target).get('password')}); closeModal(); Swal.fire('Success'); }
        async function toggleUser(id, curr){ await api.action('put',`users/${id}`,{isActive:!curr}); api.fetchData(); }
        async function unlinkLine(id){ if((await Swal.fire({title:'Unlink?',showCancelButton:true})).isConfirmed){ await api.action('put',`users/${id}`,{resetLine:true}); api.fetchData(); } }
        
        function openEditBookingModal(id){ const b=state.bookings.find(x=>x._id===id); modalData=b; document.getElementById('eb-car').innerHTML='<option value="">--</option>'+state.cars.map(c=>`<option value="${c._id}" ${b.carId?._id===c._id?'selected':''}>${c.name}</option>`).join(''); document.getElementById('eb-driver').innerHTML='<option value="">--</option>'+state.drivers.map(d=>`<option value="${d._id}" ${b.driverId?._id===d._id?'selected':''}>${d.name}</option>`).join(''); document.getElementById('eb-s-odo').value=b.startOdometer||0; document.getElementById('eb-e-odo').value=b.endOdometer||0; document.getElementById('eb-fuel').value=b.fuelCost||0; document.getElementById('eb-toll').value=b.tollCost||0; openModal('editBookingModal'); }
        async function handleEditBookingSubmit(e){ e.preventDefault(); const d={carId:document.getElementById('eb-car').value||null, driverId:document.getElementById('eb-driver').value||null, startOdometer:document.getElementById('eb-s-odo').value, endOdometer:document.getElementById('eb-e-odo').value, fuelCost:document.getElementById('eb-fuel').value, tollCost:document.getElementById('eb-toll').value}; await api.action('put',`bookings/${modalData._id}`,d); closeModal(); Swal.fire('Updated'); api.fetchData(); }

        // üî• FIX: Improved Logout
        function logout(){ 
            localStorage.clear(); 
            state.currentUser = null; 
            renderApp(); 
        }
        // üî• FIX: LINE Connect
        function openLineQR(){ if(!state.currentUser?._id) return Swal.fire('Error','User ID not found','error'); api.action('post','generate-link-token',{userId:state.currentUser._id}).then(r=>{if(r.success)Swal.fire({title:'LINE Connect',html:`<div class="flex justify-center"><img src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(`https://line.me/R/oaMessage/${LINE_BOT_ID}/?!link ${r.data.token}`)}"></div>`});}); }
        function exportCSV(){ const csv="\uFEFFDate,User,Car,Driver,Start,End,Fuel,Toll\n"+state.bookings.map(b=>`${b.startDate},"${b.userId}","${b.carId?.name||'-'}","${b.driverId?.name||'-'}",${b.startOdometer||0},${b.endOdometer||0},${b.fuelCost||0},${b.tollCost||0}`).join('\n'); const a=document.createElement('a'); a.href='data:text/csv;charset=utf-8,'+encodeURI(csv); a.download='report.csv'; a.click(); }
        function changeMonth(n){ state.currentDate=dayjs(state.currentDate).add(n,'month').toDate(); renderApp(); }
        
        function showBookingDetails(id) {
            const b = state.bookings.find(x => x._id === id);
            if(!b) return;
            const car = state.cars.find(c => c._id === b.carId) || {name: '-', plate: '-'};
            const carName = b.carId?.name || car.name || '-';
            const carPlate = b.carId?.plate || car.plate || '-';
            const driver = state.drivers.find(d => d._id === b.driverId) || {name: '-', phone: '-'};
            const driverName = b.driverId?.name || driver.name || '-';
            const driverPhone = b.driverId?.phone || driver.phone || '-';
            const user = state.users.find(u => u.username === b.userId) || {firstName: b.userId, lastName: '', department: '-'};
            const formatDate = (d) => dayjs(d).format('DD MMM BBBB');
            
            const statusColors = {
                'approved': 'bg-blue-100 text-blue-700',
                'active': 'bg-green-100 text-green-700',
                'pending': 'bg-yellow-100 text-yellow-700',
                'maintenance': 'bg-orange-100 text-orange-700',
                'completed': 'bg-teal-100 text-teal-700',
                'cancelled': 'bg-gray-100 text-gray-500',
                'rejected': 'bg-red-100 text-red-600'
            };
            const statusClass = statusColors[b.status] || 'bg-gray-100';

            let statsHtml = '';
            if (b.status === 'completed' || b.status === 'active') {
                 statsHtml = `
                <div class="mt-4 pt-3 border-t border-dashed">
                    <h4 class="text-xs font-bold text-gray-400 uppercase mb-2">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á</h4>
                    <div class="grid grid-cols-3 gap-2 text-center bg-gray-50 p-2 rounded-lg">
                        <div><p class="text-[10px] text-gray-400">‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á</p><p class="font-bold text-sm text-gray-800">${(b.endOdometer && b.startOdometer) ? (b.endOdometer - b.startOdometer).toLocaleString() : '-'} <span class="text-[10px]">km</span></p></div>
                        <div><p class="text-[10px] text-gray-400">‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô</p><p class="font-bold text-sm text-gray-800">${b.fuelCost || 0} <span class="text-[10px]">‡∏ø</span></p></div>
                        <div><p class="text-[10px] text-gray-400">‡∏Ñ‡πà‡∏≤‡∏ó‡∏≤‡∏á‡∏î‡πà‡∏ß‡∏ô</p><p class="font-bold text-sm text-gray-800">${b.tollCost || 0} <span class="text-[10px]">‡∏ø</span></p></div>
                    </div>
                </div>`;
            }

            Swal.fire({
                html: `
                    <div class="text-left space-y-4">
                        <div class="flex justify-between items-start border-b pb-3">
                            <div>
                                <h3 class="font-bold text-lg text-gray-800 leading-tight">${b.remarks || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î'}</h3>
                                <p class="text-[10px] text-gray-400 mt-1">ID: ${b._id.slice(-6).toUpperCase()}</p>
                            </div>
                            <span class="px-3 py-1 rounded-full text-xs font-bold uppercase ${statusClass}">${b.status}</span>
                        </div>

                        <div class="flex items-center gap-3 bg-blue-50 p-3 rounded-xl border border-blue-100">
                            <div class="flex-1">
                                <p class="text-[10px] text-gray-500 uppercase">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</p>
                                <p class="font-bold text-sm text-blue-700">${formatDate(b.startDate)}</p>
                                <p class="text-xs font-mono text-gray-600 bg-white inline-block px-1.5 rounded mt-0.5">${b.startTime}</p>
                            </div>
                            <div class="text-blue-300"><i data-lucide="arrow-right" class="w-5 h-5"></i></div>
                            <div class="flex-1 text-right">
                                <p class="text-[10px] text-gray-500 uppercase">‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</p>
                                <p class="font-bold text-sm text-blue-700">${formatDate(b.endDate)}</p>
                                <p class="text-xs font-mono text-gray-600 bg-white inline-block px-1.5 rounded mt-0.5">${b.endTime}</p>
                            </div>
                        </div>

                        <div class="flex items-center gap-3 p-2 border rounded-lg bg-gray-50">
                            <div class="bg-white p-2 rounded-full border shadow-sm"><i data-lucide="user" class="text-gray-600 w-5 h-5"></i></div>
                            <div>
                                <p class="text-[10px] text-gray-400 uppercase font-bold">‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á</p>
                                <p class="font-bold text-sm text-gray-800">${user.firstName} ${user.lastName}</p>
                                <p class="text-xs text-gray-500">${user.department || '-'}</p>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-3">
                            <div class="border p-3 rounded-xl bg-white relative overflow-hidden group hover:border-blue-300 transition">
                                <div class="absolute top-2 right-2 opacity-10"><i data-lucide="car" class="w-8 h-8"></i></div>
                                <p class="text-[10px] text-gray-400 uppercase font-bold mb-1">‡∏¢‡∏≤‡∏ô‡∏û‡∏≤‡∏´‡∏ô‡∏∞</p>
                                <p class="font-bold text-sm text-gray-800 truncate" title="${carName}">${carName}</p>
                                <p class="text-xs bg-gray-100 text-gray-600 inline-block px-1.5 py-0.5 rounded mt-1 font-mono">${carPlate}</p>
                            </div>
                            <div class="border p-3 rounded-xl bg-white relative overflow-hidden group hover:border-green-300 transition">
                                <div class="absolute top-2 right-2 opacity-10"><i data-lucide="steering-wheel" class="w-8 h-8"></i></div>
                                <p class="text-[10px] text-gray-400 uppercase font-bold mb-1">‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö</p>
                                <p class="font-bold text-sm text-gray-800 truncate" title="${driverName}">${driverName}</p>
                                <p class="text-xs text-gray-500 mt-1 flex items-center gap-1"><i data-lucide="phone" class="w-3 h-3"></i> ${driverPhone}</p>
                            </div>
                        </div>
                        ${statsHtml}
                    </div>
                `,
                showConfirmButton: true,
                confirmButtonText: '‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á',
                confirmButtonColor: '#3b82f6',
                width: '400px',
                didOpen: () => lucide.createIcons()
            });
        }

        function openModal(id){ document.getElementById(id).classList.add('show'); }
        function closeModal(){ document.querySelectorAll('.modal').forEach(e=>e.classList.remove('show')); }
        async function handleChangePwdSubmit(e){ e.preventDefault(); await api.action('post','change-password',{userId:state.currentUser.id,...Object.fromEntries(new FormData(e.target))}); closeModal(); Swal.fire('Success'); }
        
        function renderCharts() { 
            if(!state.stats) return;
            const render = (id, type, labels, data, colors, horizontal=false) => {
                const ctx = document.getElementById(id);
                if (ctx) {
                    Chart.getChart(ctx)?.destroy();
                    new Chart(ctx, { type, data: { labels, datasets: [{ label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏á‡∏≤‡∏ô', data, backgroundColor: colors, borderRadius: 6 }] }, options: { indexAxis: horizontal ? 'y' : 'x', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: type === 'doughnut' } } } });
                }
            };
            const carStats = state.stats.carStats || []; render('carChart', 'bar', carStats.map(x=>x.name), carStats.map(x=>x.count), '#3b82f6');
            const driverStats = state.stats.driverStats || []; render('driverChart', 'bar', driverStats.map(x=>x.name), driverStats.map(x=>x.count), '#10b981', true);
            const deptStats = state.stats.deptStats || []; render('deptChart', 'doughnut', deptStats.map(x=>x.name), deptStats.map(x=>x.count), ['#3b82f6','#10b981','#f59e0b','#ef4444','#8b5cf6']);
        }

        window.onload = () => { renderApp(); if(state.currentUser) api.fetchData(); };
    </script>
</body>
</html>
